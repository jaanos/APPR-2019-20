---
title: "Kreditno tveganje"
author: "Stefan Đekanović"
output:
  html_document: default
  pdf_document:
    includes:
      in_header: lib/styles.sty
    latex_engine: xelatex
runtime: shiny
---

```{r setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Če želimo nastaviti pisave v PDF-ju, odkomentiramo
# in sledimo navodilom v programu.
#source("fontconfig.r", encoding="UTF-8")

# Uvoz vseh potrebnih knjižnic
source("lib/libraries.r", encoding="UTF-8")
```

```{r rstudio, echo=FALSE, results='asis'}
# Izris povezave do RStudia na Binderju
source("lib/rstudio.r", encoding="UTF-8")
```

# Izbira teme

V projektu bom najprej predstavil in analiziral nekaj splošnih stvari o Nemčiji in njenih regijah. Glavni del naloge pa bo analiza kreditnega tveganja v Nemčiji in zgradba napovednega modela iz teh podatkov. Pri tem delu so meritve posamezniki in spremenljivke njegovi atributi. Glede na te atribute se posamezniku določi dobra ali slaba kreditna ocena.  Podatke o kreditnem tveganju sem dobil na spletni strani Kaggle v CSV obliki. Ostale podatke kot so populacija, GDP in površine regij sem pridobil iz Wikipedije in Eurostata.

Povezave do podatkovnih virov:

* [Kaggle](https://www.kaggle.com/uciml/german-credit) - v obliki CSV
* [Wiki](https://en.wikipedia.org/wiki/States_of_Germany) - v obliki HTML
* [Eurostat](https://ec.europa.eu/eurostat/data/database) - v obliki HTML

Zasnova podatkovnega modela:

* Tabela 1: regija, leto, glavno mesto, površina, populacija, GDP
* Tabela 2: ID, starost, spol, zaposlitev..., kreditna ocena
* Tabela 3: leto, GDP, izdatki za končno potrošnjo, uvoz surovin, izvoz surovin

Na zaključku projekta bom zgradil osnovni klasifikacijski model za napoved kreditne ocene posameznika. Uporabil bom tudi metodo razvrščanja v skupine, da bi najdel množice primerov, ki so si medsebojno podobni.

***

# Obdelava, uvoz in čiščenje podatkov

```{r uvoz, echo=FALSE, message=FALSE}
source("uvoz/uvoz.r", encoding="UTF-8")
```

Za tabelo 1 sem uvozil podatke s spletne strani Wikipedija. Razpredelnica `tabela1`  ima 16 vrstic, ki predstavljajo regije, in 15 stolpcev. Najprej sem zbrisal nepotrebne stolpce nato pa si pogledal njihove tipe:

```{r}
sapply(tabela1, class)
```

Nekaterim stolpcem sem spremenil tip, nadomestil sem manjkajoče vrednosti z pravimi vrednostmi in spremenil imena stolpev v slovenščino. Nekateri podatki so imeli tudi drugačen zapis decimalnega števila. S pomočjo stolpca populacija in GDP na prebivalca sem določil stolpec GDP. 

Opis prečiščene tabele 1:
1. `tabela1` - splošni podatki o regijah
  - `Regije` - spremenljivka: ime regije (faktor)
  - `Leto` - spremenljivka: leto (število)
  - `Glavno mesto` - spremenljivka: glavno mesto v regiji (faktor)
  - `Povrsina` - meritev: površina regije v km$^2$ (število)
  - `Populacija` - meritev: število prebivalcev v regiji (število)
  - `GDP` - meritev: GDP regije v milijonih € (število)

  
Tabela 2, ki predstavlja posameznike in njihove lastnosti, je v mnogo lepši obliki kot prejšnje tabele.
```{r}
sapply(tabela2, class)
```

Stolpce sem preimenoval v slovenščino. Količina kredita je podana v nemških markah in ji vrednosti spremenimo v evre. Vse spremenljivke in vrednosti sem prevedel iz angleščine v slovenščino.

Opis prešiščene tabele 2:
3. `tabela2` - podatki o posameznikih, ki vzamejo kredit
  - `ID` - spremenljivka: id posameznika
  - `Starost` - meritev: starost posameznika (število)
  - `Spol` - meritev: spol posameznika (neurejen faktor)
  - `Zaposlitev` - meritev: trenutna zaposlitev posameznika (faktor); 0 - nezaposlen, 1 - nekvalificiran delavec, 2 - kvalificiran, 3 - visoko kvalificiran
  - `Nastanitev` - meritev: tip nastanitve (faktor); "lastno", "najem", "drugo"
  - `Prihranki` - meritev: število prihrankov na računu (število)
  - `Velikost kredita` - meritev: velikost kredita, ki ga vzame, v evrih (število)
  - `Trajanje` - meritev: trajanje kredita, ki ga vzame, v mesecih (število)
  - `Namen` - meritev: namen (neurejen faktor); "radio/TV", "izobrazba", "pohištvo/oprema", "avto", "posel", "gospodinjski aparati", "popravila", "drugo" 
  - `Ocena` - meritev: kreditna ocena posameznika (faktor); 0 - slabo tveganje, 1 - dobro tveganje


## Preliminarna analiza

Če si pogledamo kako je porazdeljena ciljna spremenljivka, vidimo, da je posameznikov z dobro oceno veliko več kot  tistih s slabo.

```{r}
ggplot(tabela2, aes(x = Ocena, fill = Ocena))+
  geom_bar() +
  xlab("Ocena") + ylab("Število")
```

Poglejmo si še to porazdelitev glede na spol in starost.

```{r}
ggplot(tabela2, aes(x = Ocena, fill = Spol)) + 
  geom_bar() +
  xlab("Ocena") + ylab("Število")
```

Iz zgornjega grafa opazimo, da imamo več posameznikov moškega spola. Prav tako večji delež moških dobi dobro kreditno oceno. Natančen izračun deleža:

```{r}
steviloDobrih <- tabela2 %>% group_by(Spol) %>% summarise(Stevilo = count(Ocena))
nMoskih <- tabela2 %>% filter(Spol == "moški") %>% count()
nZenskih <- tabela2 %>% filter(Spol == "ženska") %>% count()
delezM <- round(steviloDobrih$Stevilo[1]/nMoskih, 2)
delezZ <- round(steviloDobrih$Stevilo[2]/nZenskih, 2)
print(sprintf("Delež moških, ki imajo dobro oceno, je %.2f", delezM))
print(sprintf("Delež žensk, ki imajo dobro oceno, je %.2f", delezZ))
```

Porazdelitev glede starosti:

```{r}
ggplot(tabela2, aes(x = Starost, fill = Ocena))+
  geom_bar() +
  ylab("Število")
```

V nadaljevanju si bom pogledal še druge spremenljivke in njihovo obnašanje glede na ciljno spremenljivko.

***

# Analiza in vizualizacija podatkov

```{r vizualizacija, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
source("vizualizacija/vizualizacija.r", encoding="UTF-8")
```

Spodnji zemljevid prikazuje povprečno velikost družine za vsako občino.

```{r zemljevid, echo=FALSE, fig.align='center', fig.cap='Zemljevid povprečnega števila otrok v družini', warning=FALSE}
tm_shape(merge(zemljevid, povprecja, by.x="OB_UIME", by.y="obcina")) +
  tm_polygons("povprecje", title="Povprečje") +
  tm_layout(title="Povprečno število otrok v družini")
```

***

# Napredna analiza podatkov

```{r analiza, echo=FALSE, message=FALSE}
source("analiza/analiza.r", encoding="UTF-8")
```

Spodnji graf prikazuje povezavo med številom naselij in površino občine.

```{r graf, echo=FALSE, fig.align='center', fig.cap='Povezava med številom naselij in površino občine'}
ggplot(inner_join(obcine, data.frame(obcina=names(skupine),
                                     skupina=factor(skupine)), by="obcina")
, aes(x=povrsina, y=naselja, color=skupina, size=prebivalci/1000)) + geom_point() +
  ggtitle("Število naselij glede na površino občine") +
  xlab(expression("Površina (km"^2 * ")")) + ylab("Št. naselij") +
  guides(color=guide_legend(title="Skupina"),
         size=guide_legend(title="Prebivalci (* 1000)"))
```

***

```{r shiny, echo=FALSE}
shinyAppDir("shiny", options=list(width="100%", height=600))
```
